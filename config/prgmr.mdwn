We choose an instance with the default Debian Lenny installation.

# Base system

    ssh-keygen -t rsa  # send ~/.ssh/id_rsa.pub to prgmr
    ssh -i ~/.ssh/id_rsa username@stone.prgmr.com  # username, stone: can be something else

We are now in the console menu. Choose 1 to login as root using password 'password'. We start by upgrading to Debian Squeeze.

    passwd
    aptitude
    # go to preferences (ctrl+t)
    # disable automatic installation of recommended packages
    # update
    # upgrade
    sed -i s/lenny/squeeze/g /etc/apt/sources.list
    aptitude dist-upgrade
    # repeat if necessary
    # don't install the new grub!
    aptitude install grub-legacy
    update-grub
    # make sure /boot/grub/menu.lst looks sane
    shutdown -r now
    # hope that the system comes up again
    # login again from the console menu
    aptitude dist-upgrade
    # this extra dist-upgrade run is probably not needed

Now that we have successfully upgraded to Squeeze, we add the first user and disable root.

    adduser martijn
    addgroup admin
    adduser martijn admin
    aptitude install sudo
    echo '%admin ALL=(ALL) ALL' >> /etc/sudoers
    # try to login as 'martijn' (at username.xen.prgmr.com)
    sudo -l
    # if we are ok, logout as root and disable root
    sudo passwd -l root

Configure aptitude.

    echo 'aptitude::Get-Root-Command "sudo:/usr/bin/sudo";' > /etc/apt/apt.conf
    aptitude
    # go to preferences (ctrl+t)
    # disable automatic installation of recommended packages

Install some packages.

    aptitude install emacs bash-completion screen subversion htop

Get some dot files.

    svn co $SVNURL .home
    ln -s ~martijn/.home/.bashrc
    ln -s ~martijn/.home/.inputrc
    ln -s ~martijn/.home/.emacs
    ln -s ~martijn/.home/.profile
    ln -s ~martijn/.home/.screenrc
    ln -s ~martijn/.home/bin

# Security

Run sshd on another port.

    sed -i 's/Port 22/Port 404/' /etc/ssh/sshd_config

We use the very simple iptables frontend ufw.

    aptitude install ufw
    sed -i s/22/404/g /etc/ufw/applications.d/openssh-server
    ufw default deny
    ufw allow OpenSSH
    ufw enable

# nginx

We want newer nginx from testing, so we add the testing repository to our sources and use pinning to set Squeeze as default repository.

    echo 'deb http://ftp.us.debian.org/debian testing main' >> /etc/apt/sources.list
    echo "Package: *
    Pin: release n=squeeze
    Pin-Priority: 900

    Package: *
    Pin: release a=testing
    Pin-Priority: 100" > /etc/apt/preferences

The nginx-light package only exists in testing, so it can be installed just by name.

    aptitude install nginx-light
    sed -i 's/worker_processes 4/worker_processes 1/' /etc/nginx/nginx.conf

# PHP

We want php5-fpm which is not in Debian (not even experimental at this moment). We get it from the Dotdeb repository.

    echo "deb http://packages.dotdeb.org squeeze all" >> /etc/apt/sources.list

Update the pinning settings in /etc/apt/preferences to give Dotdeb lowest priority, except for our PHP packages.

    Package: *
    Pin: release n=squeeze
    Pin-Priority: 900

    Package: *
    Pin: release a=testing
    Pin-Priority: 200

    Package: *
    Pin: origin packages.dotdeb.org
    Pin-Priority: 100

    Package: php5-common php5-fpm php5-mysql php5-gd
    Pin: origin packages.dotdeb.org
    Pin-Priority: 900

Now install the packages we need.

    aptitude install php5-common php5-fpm php5-mysql php5-gd

# MySQL

Have a look at /usr/share/doc/mysql-server-5.1/examples for inspiration.

    aptitude install mysql-server mysql-client
    echo skip-innodb >> /etc/mysql/my.cnf  # and edit some memory settings

# Wordpress

    http://blogs.sitepoint.com/2010/11/19/lightning-fast-wordpress-with-php-fpm-and-nginx/
    http://wordpress.org/support/topic/nginx-php-fpm-php-apc-wordpress-multisite-subdirectory-wp-super-cache
    http://lekkernerden.nl/2011/02/php5-fpm-php5-apc-segfault/
    http://news.ycombinator.com/item?id=2208760
    http://forum.slicehost.com/comments.php?DiscussionID=5099
    http://wiki.nginx.org/Pitfalls

# Services to migrate from the old system

* Subversion server (via http)
* rosanne.vermaat.name
* vondellaan.vermaat.name
* martijn.vermaat.name
* janny.vermaat.name
* deleesplank.nl
* MySQL server

# Links

[Tips for setting up Debian](http://book.prgmr.com/mediawiki/index.php/Tips_for_setting_up_Debian)
